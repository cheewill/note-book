
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>054. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（一） · 亿级流量电商详情页系统实战</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="刘凯（kaisesai）">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-flexible-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-page-copyright/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-multipart/multipart.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-page-treeview/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="055.html" />
    
    
    <link rel="prev" href="053.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">第一版</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="001-introduce.html">
            
                <a href="001-introduce.html">
            
                    
                    001. 课程介绍以及高并发高可用复杂系统中的缓存架构有哪些东西
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="002.html">
            
                <a href="002.html">
            
                    
                    002. 基于大型电商网站中的商品详情页系统贯穿的授课思路介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="003.html">
            
                <a href="003.html">
            
                    
                    003. 小型电商网站的商品详情页的页面静态化架构以及其缺陷
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="004.html">
            
                <a href="004.html">
            
                    
                    004. 大型电商网站的异步多级缓存构建 + nginx 数据本地化动态渲染的架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="005.html">
            
                <a href="005.html">
            
                    
                    005. 能够支撑高并发+高可用+海量数据+备份恢复的 redis 的重要性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="006.html">
            
                <a href="006.html">
            
                    
                    006. 从零开始在虚拟机中一步一步搭建一个 4 个节点的 CentOS 集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="redis/007.html">
            
                <a href="redis/007.html">
            
                    
                    007. 单机版 redis 的安装以及 redis 生产环境启动方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="redis/008.html">
            
                <a href="redis/008.html">
            
                    
                    008. redis 持久化机对于生产环境中的灾难恢复的意义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="redis/009.html">
            
                <a href="redis/009.html">
            
                    
                    009. 图解分析 redis 的 RDB 和 AOF 两种持久化机制的工作原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="redis/010.html">
            
                <a href="redis/010.html">
            
                    
                    010. redis 的 RDB 和 AOF 两种持久化机制的优劣势对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="redis/011.html">
            
                <a href="redis/011.html">
            
                    
                    011. redis 的 RDB 持久化配置以及数据恢复实验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="redis/012.html">
            
                <a href="redis/012.html">
            
                    
                    012. redis 的 AOF 持久化深入讲解各种操作和相关实验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="redis/013.html">
            
                <a href="redis/013.html">
            
                    
                    013. 在项目中部署 redis 企业级数据备份方案以及各种踩坑的数据恢复容灾演练
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="redis/014.html">
            
                <a href="redis/014.html">
            
                    
                    014. redis 如何通过读写分离来承载读请求 QPS 超过 10 万 +？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="redis/015.html">
            
                <a href="redis/015.html">
            
                    
                    015. redis replication 以及 master 持久化对主从架构的安全意义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="redis/016.html">
            
                <a href="redis/016.html">
            
                    
                    016. redis 主从复制原理、断点续传、无磁盘化复制、过期 key 处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="redis/017.html">
            
                <a href="redis/017.html">
            
                    
                    017. redis replication 的完整流运行程和原理的再次深入剖析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="redis/018.html">
            
                <a href="redis/018.html">
            
                    
                    018. 在项目中部署 redis 的读写分离架构（包含节点间认证口令）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="redis/019.html">
            
                <a href="redis/019.html">
            
                    
                    019. 对项目的主从 redis 架构进行 QPS 压测以及水平扩容支撑更高 QPS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="redis/020.html">
            
                <a href="redis/020.html">
            
                    
                    020. redis 主从架构下如何才能做到 99.99% 的高可用性？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.22" data-path="redis/021.html">
            
                <a href="redis/021.html">
            
                    
                    021. redis 哨兵架构的相关基础知识的讲解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.23" data-path="redis/022.html">
            
                <a href="redis/022.html">
            
                    
                    022. redis 哨兵主备切换的数据丢失问题：异步复制、集群脑裂
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24" data-path="redis/023.html">
            
                <a href="redis/023.html">
            
                    
                    023. redis 哨兵的多个核心底层原理的深入解析（包含 slave 选举算法）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.25" data-path="redis/024.html">
            
                <a href="redis/024.html">
            
                    
                    024. 在项目中以经典的 3 节点方式部署哨兵集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.26" data-path="redis/025.html">
            
                <a href="redis/025.html">
            
                    
                    025. 对项目中的哨兵节点进行管理以及高可用 redis 集群的容灾演练
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.27" data-path="redis/026.html">
            
                <a href="redis/026.html">
            
                    
                    026. redis 如何在保持读写分离+高可用的架构下，还能横向扩容支撑 1T + 海量数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.28" data-path="redis/027.html">
            
                <a href="redis/027.html">
            
                    
                    027. 数据分布算法：hash+ 一致性 hash + redis cluster 的 hash slot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.29" data-path="redis/028.html">
            
                <a href="redis/028.html">
            
                    
                    028. 在项目中重新搭建一套读写分离+高可用+多 master 的 redis cluster 集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.30" data-path="redis/029.html">
            
                <a href="redis/029.html">
            
                    
                    029. 对项目的 redis cluster 实验多 master 写入、读写分离、高可用性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.31" data-path="redis/030.html">
            
                <a href="redis/030.html">
            
                    
                    030. redis cluster 通过 master 水平扩容来支撑更高的读写吞吐 + 海量数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.32" data-path="redis/031.html">
            
                <a href="redis/031.html">
            
                    
                    031. redis cluster 的自动化 slave 迁移实现更强的高可用架构的部署方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33" data-path="redis/032.html">
            
                <a href="redis/032.html">
            
                    
                    032. redis cluster 的核心原理分析：gossip 通信、jedis smart 定位、主备切换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.34" data-path="redis/033.html">
            
                <a href="redis/033.html">
            
                    
                    033. redis 在实践中的一些常见问题以及优化思路（包含 linux 内核参数优化）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.35" data-path="redis/034.html">
            
                <a href="redis/034.html">
            
                    
                    034. redis 阶段性总结：1T 以上海量数据+10 万以上 QPS 高并发+ 99.99% 高可用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36" data-path="035.html">
            
                <a href="035.html">
            
                    
                    035. 亿级流量商品详情页的多级缓存架构以及架构中每一层的意义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.37" data-path="06.md">
            
                <span>
            
                    
                    036. Cache Aside Pattern 缓存+数据库读写模式的分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.38" data-path="07.md">
            
                <span>
            
                    
                    037. 高并发场景下的缓存 + 数据库双写不一致问题分析与解决方案设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.39" data-path="038.html">
            
                <a href="038.html">
            
                    
                    038. 在 linux 虚拟机中安装部署 MySQL 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.40" data-path="039.html">
            
                <a href="039.html">
            
                    
                    039. 库存服务的开发框架整合与搭建：spring boot + mybatis + jedis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.41" data-path="040.html">
            
                <a href="040.html">
            
                    
                    040. 在库存服务中实现缓存与数据库双写一致性保障方案（一、二、三、四）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.42" data-path="044.html">
            
                <a href="044.html">
            
                    
                    044. 库存服务代码调试以及打印日志观察服务的运行流程是否正确
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.43" data-path="045.html">
            
                <a href="045.html">
            
                    
                    045. 商品详情页结构分析、缓存全量更新问题以及缓存维度化解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.44" data-path="046.html">
            
                <a href="046.html">
            
                    
                    046. 缓存数据生产服务的工作流程分析以及工程环境搭建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.45" data-path="047.html">
            
                <a href="047.html">
            
                    
                    047. 完成 spring boot 整合 ehcache 的搭建以支持服务本地堆缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.46" data-path="048.html">
            
                <a href="048.html">
            
                    
                    048. redis 的 LRU 缓存清除算法讲解以及相关配置使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.47" data-path="049.html">
            
                <a href="049.html">
            
                    
                    049. zookeeper + kafka 集群的安装部署以及如何简单使用的介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.48" data-path="050.html">
            
                <a href="050.html">
            
                    
                    050. 基于 kafka + ehcache + redis 完成缓存数据生产服务的开发与测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.49" data-path="051.html">
            
                <a href="051.html">
            
                    
                    051. 基于“分发层 + 应用层”双层 nginx 架构提升缓存命中率方案分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.50" data-path="052.html">
            
                <a href="052.html">
            
                    
                    052. 基于 OpenResty 部署应用层 nginx 以及 nginx + lua 开发 hello world
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.51" data-path="053.html">
            
                <a href="053.html">
            
                    
                    053. 部署分发层 nginx 以及基于 lua 完成基于商品 id 的定向流量分发策略
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.52" data-path="054.html">
            
                <a href="054.html">
            
                    
                    054. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（一）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.53" data-path="055.html">
            
                <a href="055.html">
            
                    
                    055. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（二）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.54" data-path="056.html">
            
                <a href="056.html">
            
                    
                    056. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（三）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.55" data-path="057.html">
            
                <a href="057.html">
            
                    
                    057. 分布式缓存重建并发冲突问题以及 zookeeper 分布式锁解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.56" data-path="058.html">
            
                <a href="058.html">
            
                    
                    058. 缓存数据生产服务中的 zk 分布式锁解决方案的代码实现（一）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.57" data-path="059.html">
            
                <a href="059.html">
            
                    
                    059. 缓存数据生产服务中的 zk 分布式锁解决方案的代码实现（二）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.58" data-path="060.html">
            
                <a href="060.html">
            
                    
                    060. 缓存数据生产服务中的 zk 分布式锁解决方案的代码实现（三）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.59" data-path="061.html">
            
                <a href="061.html">
            
                    
                    061. Java 程序员、缓存架构以及 Storm 大数据实时计算之间的关系
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.60" data-path="storm/062.html">
            
                <a href="storm/062.html">
            
                    
                    062. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：大白话介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.61" data-path="storm/063.html">
            
                <a href="storm/063.html">
            
                    
                    063. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：大白话讲集群架构与核心概念
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.62" data-path="storm/064.html">
            
                <a href="storm/064.html">
            
                    
                    064. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：大白话讲并行度和流分组
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.63" data-path="storm/065.html">
            
                <a href="storm/065.html">
            
                    
                    065. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：纯手敲 WordCount 程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.64" data-path="storm/066.html">
            
                <a href="storm/066.html">
            
                    
                    066. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：纯手工集群部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.65" data-path="storm/067.html">
            
                <a href="storm/067.html">
            
                    
                    067. 讲给 Java 工程师的史上最通俗易懂 Storm 教程：基于集群运行计算拓扑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.66" data-path="068.html">
            
                <a href="068.html">
            
                    
                    068. 缓存冷启动问题：新系统上线 redis 彻底崩溃导致数据无法恢复
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.67" data-path="069.html">
            
                <a href="069.html">
            
                    
                    069. 缓存预热解决方案：基于 storm 实时热点统计的分布式并行缓存预热
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.68" data-path="070.html">
            
                <a href="070.html">
            
                    
                    070. 基于 nginx+lua 完成商品详情页访问流量实时上报 kafka 的开发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.69" data-path="071.html">
            
                <a href="071.html">
            
                    
                    071. 基于 storm+kafka 完成商品访问次数实时统计拓扑的开发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.70" data-path="072.html">
            
                <a href="072.html">
            
                    
                    072. 基于 storm 完成 LRUMap 中 topn 热门商品列表的算法讲解与编写
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.71" data-path="073.html">
            
                <a href="073.html">
            
                    
                    073. 基于 storm+zookeeper 完成热门商品列表的分段存储
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.72" data-path="074.html">
            
                <a href="074.html">
            
                    
                    074. 基于双重 zookeeper 分布式锁完成分布式并行缓存预热的代码开发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.73" data-path="075.html">
            
                <a href="075.html">
            
                    
                    075. 将缓存预热解决方案的代码运行后观察效果以及调试和修复所有的 bug
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.74" data-path="076.html">
            
                <a href="076.html">
            
                    
                    076. 热点缓存问题：促销抢购时的超级热门商品可能导致系统全盘崩溃的场景
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.75" data-path="077.html">
            
                <a href="077.html">
            
                    
                    077. 基于 nginx+lua+storm 的热点缓存的流量分发策略自动降级解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.76" data-path="078.html">
            
                <a href="078.html">
            
                    
                    078. 在 storm 拓扑中加入热点缓存实时自动识别和感知的代码逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.77" data-path="079.html">
            
                <a href="079.html">
            
                    
                    079. 在 storm 拓扑中加入 nginx 反向推送缓存热点与缓存数据的代码逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.78" data-path="080.html">
            
                <a href="080.html">
            
                    
                    080. 在流量分发+后端应用双层 nginx 中加入接收热点缓存数据的接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.79" data-path="081.html">
            
                <a href="081.html">
            
                    
                    081. 在 nginx+lua 中实现热点缓存自动降级为负载均衡流量分发策略的逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.80" data-path="082.html">
            
                <a href="082.html">
            
                    
                    082. 在 storm 拓扑中加入热点缓存消失的实时自动识别和感知的代码逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.81" data-path="083.html">
            
                <a href="083.html">
            
                    
                    083. 将热点缓存自动降级解决方案的代码运行后观察效果以及调试和修复 bug
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.82" data-path="hystrix/084.html">
            
                <a href="hystrix/084.html">
            
                    
                    084. hystrix 与高可用系统架构：资源隔离+限流+熔断+降级+运维监控
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.83" data-path="hystrix/085.html">
            
                <a href="hystrix/085.html">
            
                    
                    085. hystrix 要解决的分布式系统可用性问题以及其设计原则
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.84" data-path="hystrix/086.html">
            
                <a href="hystrix/086.html">
            
                    
                    086. 电商网站的商品详情页缓存服务业务背景以及框架结构说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.85" data-path="hystrix/087.html">
            
                <a href="hystrix/087.html">
            
                    
                    087. 基于 spring boot 快速构建缓存服务以及商品服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.86" data-path="hystrix/088.html">
            
                <a href="hystrix/088.html">
            
                    
                    088. 快速完成缓存服务接收数据变更消息以及调用商品服务接口的代码编写
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.87" data-path="hystrix/089.html">
            
                <a href="hystrix/089.html">
            
                    
                    089. 商品服务接口故障导致的高并发访问耗尽缓存服务资源的场景分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.88" data-path="hystrix/090.html">
            
                <a href="hystrix/090.html">
            
                    
                    090. 基于 hystrix 的线程池隔离技术进行商品服务接口的资源隔离
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.89" data-path="hystrix/091.html">
            
                <a href="hystrix/091.html">
            
                    
                    091. 基于 hystrix 的信号量技术对地理位置获取逻辑进行资源隔离与限流
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.90" data-path="hystrix/092.html">
            
                <a href="hystrix/092.html">
            
                    
                    092. hystrix 的线程池+服务+接口划分以及资源池的容量大小控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.91" data-path="hystrix/093.html">
            
                <a href="hystrix/093.html">
            
                    
                    093. 深入分析 hystrix 执行时的 8 大流程步骤以及内部原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.92" data-path="hystrix/094.html">
            
                <a href="hystrix/094.html">
            
                    
                    094. 基于 request cache 请求缓存技术优化批量商品数据查询接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.93" data-path="hystrix/095.html">
            
                <a href="hystrix/095.html">
            
                    
                    095. 开发品牌名称获取接口的基于本地缓存的 fallback 降级机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.94" data-path="hystrix/096.html">
            
                <a href="hystrix/096.html">
            
                    
                    096. 深入理解 hystrix 的短路器执行原理以及模拟接口异常时的短路实验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.95" data-path="hystrix/097.html">
            
                <a href="hystrix/097.html">
            
                    
                    097. 深入理解线程池隔离技术的设计原则以及动手实战接口限流实验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.96" data-path="hystrix/098.html">
            
                <a href="hystrix/098.html">
            
                    
                    098. 基于 timeout 机制来为商品服务接口的调用超时提供安全保护
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.97" data-path="hystrix/099.html">
            
                <a href="hystrix/099.html">
            
                    
                    099. 基于 hystrix 的高可用分布式系统架构项目实战课程的总结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.98" data-path="hystrix/100.html">
            
                <a href="hystrix/100.html">
            
                    
                    100. 基于 request collapser 请求合并技术进一步优化批量查询
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.99" data-path="hystrix/101.html">
            
                <a href="hystrix/101.html">
            
                    
                    101. hystirx 的 fail-fast 与 fail-silient 两种最基础的容错模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.100" data-path="hystrix/102.html">
            
                <a href="hystrix/102.html">
            
                    
                    102. 为商品服务接口调用增加 stubbed fallback 降级机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.101" data-path="hystrix/103.html">
            
                <a href="hystrix/103.html">
            
                    
                    103. 基于双层嵌套 command 开发商品服务接口的多级降级机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.102" data-path="hystrix/104.html">
            
                <a href="hystrix/104.html">
            
                    
                    104. 基于 facade command 开发商品服务接口的手动降级机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.103" data-path="hystrix/105.html">
            
                <a href="hystrix/105.html">
            
                    
                    105. 生产环境中的线程池大小以及 timeout 超时时长优化经验总结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.104" data-path="hystrix/106.html">
            
                <a href="hystrix/106.html">
            
                    
                    106. 生产环境中的线程池自动扩容与缩容的动态资源分配经验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.105" data-path="hystrix/107.html">
            
                <a href="hystrix/107.html">
            
                    
                    107. hystrix 的 metric 统计相关的各种高阶配置讲解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.106" data-path="hystrix/108.html">
            
                <a href="hystrix/108.html">
            
                    
                    108. hystrix dashboard 可视化分布式系统监控环境部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.107" data-path="hystrix/109.html">
            
                <a href="hystrix/109.html">
            
                    
                    109. 生产环境中的hystrix分布式系统的工程运维经验总结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.108" data-path="110.html">
            
                <a href="110.html">
            
                    
                    110. 高并发场景下恐怖的缓存雪崩现象以及导致系统全盘崩溃的后果
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.109" data-path="111.html">
            
                <a href="111.html">
            
                    
                    111. 缓存雪崩的基于事前+事中+事后三个层次的完美解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.110" data-path="112.html">
            
                <a href="112.html">
            
                    
                    112. 基于 hystrix 完成对 redis 访问的资源隔离以避免缓存服务被拖垮
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.111" data-path="113.html">
            
                <a href="113.html">
            
                    
                    113. 为 redis 集群崩溃时的访问失败增加 fail silent 容错机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.112" data-path="114.html">
            
                <a href="114.html">
            
                    
                    114. 为 redis 集群崩溃时的场景部署定制化的熔断策略
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.113" data-path="115.html">
            
                <a href="115.html">
            
                    
                    115. 基于 hystrix 限流完成源服务的过载保护以避免流量洪峰打死 MySQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.114" data-path="116.html">
            
                <a href="116.html">
            
                    
                    116. 为源头服务的限流场景增加 stubbed fallback 降级机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.115" data-path="117.html">
            
                <a href="117.html">
            
                    
                    117. 高并发场景下的缓存穿透导致 MySQL 压力倍增问题以及其解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.116" data-path="118.html">
            
                <a href="118.html">
            
                    
                    118. 在缓存服务中开发缓存穿透的保护性机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.117" data-path="119.html">
            
                <a href="119.html">
            
                    
                    119. 高并发场景下的 nginx 缓存失效导致 redis 压力倍增问题以及解决方案
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.118" data-path="120.html">
            
                <a href="120.html">
            
                    
                    120. 在 nginx lua 脚本中开发缓存失效的保护性机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.119" data-path="121.html">
            
                <a href="121.html">
            
                    
                    121. 支撑高并发与高可用的大型电商详情页系统的缓存架构课程总结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.120" data-path="122.html">
            
                <a href="122.html">
            
                    
                    122. 如何将课程中的东西学以致用在自己目前的项目中去应用？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.121" data-path="123.html">
            
                <a href="123.html">
            
                    
                    123. 如何带着课程中讲解的东西化为自己的技术并找一份更好的工作？
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第二版</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="124.html">
            
                <a href="124.html">
            
                    
                    124. 大型电商网站的商品详情页的深入分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="125.html">
            
                <a href="125.html">
            
                    
                    125. 大型电商网站的商品详情页系统架构是如何一步一步演进的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="126.html">
            
                <a href="126.html">
            
                    
                    126. 亿级流量大型电商网站的商品详情页系统架构的整体设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="dr/127.html">
            
                <a href="dr/127.html">
            
                    
                    127. 商品详情页动态渲染系统：架构整体设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="dr/128.html">
            
                <a href="dr/128.html">
            
                    
                    128. 商品详情页动态渲染系统：大型网站的多机房 4级 缓存架构设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="dr/129.html">
            
                <a href="dr/129.html">
            
                    
                    129. 商品详情页动态渲染系统：复杂的消息队列架构设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="dr/130.html">
            
                <a href="dr/130.html">
            
                    
                    130. 商品详情页动态渲染系统：使用多线程并发提升系统吞吐量的设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="dr/131.html">
            
                <a href="dr/131.html">
            
                    
                    131. 商品详情页动态渲染系统：redis 批量查询性能优化设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="dr/132.html">
            
                <a href="dr/132.html">
            
                    
                    132. 商品详情页动态渲染系统：全链路高可用架构设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="dr/133.html">
            
                <a href="dr/133.html">
            
                    
                    133. 商品详情页动态渲染系统：微服务架构设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="dr/134.html">
            
                <a href="dr/134.html">
            
                    
                    134. 商品详情页动态渲染系统：机房与机器的规划
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.12" data-path="dr/135.html">
            
                <a href="dr/135.html">
            
                    
                    135. 商品详情页动态渲染系统：部署 CentOS 虚拟机集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.13" data-path="dr/136.html">
            
                <a href="dr/136.html">
            
                    
                    136. 商品详情页动态渲染系统：双机房部署接入层与应用层 Nginx+Lua
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.14" data-path="dr/137.html">
            
                <a href="dr/137.html">
            
                    
                    137. 商品详情页动态渲染系统：为什么是 twemproxy+redis 而不是 redis cluster？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.15" data-path="dr/138.html">
            
                <a href="dr/138.html">
            
                    
                    138. 商品详情页动态渲染系统：redis 复习以及 twemproxy 基础知识讲解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.16" data-path="dr/139.html">
            
                <a href="dr/139.html">
            
                    
                    139. 商品详情页动态渲染系统：部署双机房一主三从架构的 redis 主集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.17" data-path="dr/140.html">
            
                <a href="dr/140.html">
            
                    
                    140. 商品详情页动态渲染系统：给每个机房部署一个 redis 从集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.18" data-path="dr/141.html">
            
                <a href="dr/141.html">
            
                    
                    141. 商品详情页动态渲染系统：为 redis 主集群部署 twemproxy 中间件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.19" data-path="dr/142.html">
            
                <a href="dr/142.html">
            
                    
                    142. 商品详情页动态渲染系统：为每个机房的 redis 从集群部署 twemproxy 中间件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.20" data-path="dr/143.html">
            
                <a href="dr/143.html">
            
                    
                    143. 商品详情页动态渲染系统：部署 RabbitMQ 消息中间件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.21" data-path="dr/144.html">
            
                <a href="dr/144.html">
            
                    
                    144. 商品详情页动态渲染系统：部署 MySQL 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.22" data-path="dr/145.html">
            
                <a href="dr/145.html">
            
                    
                    145. 商品详情页动态渲染系统：声音小问题&课程代码二次开发&商品服务需求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.23" data-path="dr/146.html">
            
                <a href="dr/146.html">
            
                    
                    146. 商品详情页动态渲染系统：工程师的 why-how-what 思考方法&价格服务说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.24" data-path="dr/147.html">
            
                <a href="dr/147.html">
            
                    
                    147. 商品详情页动态渲染系统：库存服务的场景介绍以及课程需求说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.25" data-path="dr/148.html">
            
                <a href="dr/148.html">
            
                    
                    148. 商品详情页动态渲染系统：微服务与 Spring Cloud 基本介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.26" data-path="dr/149.html">
            
                <a href="dr/149.html">
            
                    
                    149. 商品详情页动态渲染系统：Spring Boot 与微服务的关系以及开发回顾
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.27" data-path="dr/150.html">
            
                <a href="dr/150.html">
            
                    
                    150. 商品详情页动态渲染系统：Spring Cloud 之 Eureka 注册中心
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.28" data-path="dr/151.html">
            
                <a href="dr/151.html">
            
                    
                    151. 商品详情页动态渲染系统：Spring Cloud 之 Ribbon+Rest 调用负载均衡
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.29" data-path="dr/152.html">
            
                <a href="dr/152.html">
            
                    
                    152. 商品详情页动态渲染系统：Spring Cloud 之 Fegion 声明式服务调用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.30" data-path="dr/153.html">
            
                <a href="dr/153.html">
            
                    
                    153. 商品详情页动态渲染系统：Spring Cloud 之 Hystrix 熔断降级
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.31" data-path="dr/154.html">
            
                <a href="dr/154.html">
            
                    
                    154. 商品详情页动态渲染系统：Spring Cloud 之 Zuul 网关路由
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.32" data-path="dr/155.html">
            
                <a href="dr/155.html">
            
                    
                    155. 商品详情页动态渲染系统：Spring Cloud 之 Config 统一配置中心
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.33" data-path="dr/156.html">
            
                <a href="dr/156.html">
            
                    
                    156. 商品详情页动态渲染系统：Spring Cloud 之 Sleuth 调用链路追踪
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.34" data-path="dr/157.html">
            
                <a href="dr/157.html">
            
                    
                    157. 商品详情页动态渲染系统：Spring Cloud 之 Eureka Server 安全认证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.35" data-path="dr/158.html">
            
                <a href="dr/158.html">
            
                    
                    158. 商品详情页动态渲染系统：完成 Spring Boot+Spring Cloud+MyBatis 整合
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.36" data-path="dr/159.html">
            
                <a href="dr/159.html">
            
                    
                    159. 商品详情页动态渲染系统：基于 Spring Cloud 开发商品服务（一）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.37" data-path="dr/160.html">
            
                <a href="dr/160.html">
            
                    
                    160. 商品详情页动态渲染系统：基于 Spring Cloud 开发商品服务（二）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.38" data-path="dr/161.html">
            
                <a href="dr/161.html">
            
                    
                    161. 商品详情页动态渲染系统：基于 Spring Cloud 开发价格服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.39" data-path="dr/162.html">
            
                <a href="dr/162.html">
            
                    
                    162. 商品详情页动态渲染系统：基于 Spring Cloud 开发库存服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.40" data-path="dr/163.html">
            
                <a href="dr/163.html">
            
                    
                    163. 商品详情页动态渲染系统：windows 部署 rabbitmq 作为开发测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.41" data-path="dr/164.html">
            
                <a href="dr/164.html">
            
                    
                    164. 商品详情页动态渲染系统：windows 部署 redis 作为开发测试环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.42" data-path="dr/165.html">
            
                <a href="dr/165.html">
            
                    
                    165. 商品详情页动态渲染系统：依赖服务将数据变更消息写入 rabbitmq 或双写 redis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.43" data-path="dr/166.html">
            
                <a href="dr/166.html">
            
                    
                    166. 商品详情页动态渲染系统：基于 Spring Cloud 开发数据同步服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.44" data-path="dr/167.html">
            
                <a href="dr/167.html">
            
                    
                    167. 商品详情页动态渲染系统：基于 Spring Cloud 开发数据聚合服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.45" data-path="dr/168.html">
            
                <a href="dr/168.html">
            
                    
                    168. 商品详情页动态渲染系统：完成数据同步服务与数据聚合服务的测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.46" data-path="dr/169.html">
            
                <a href="dr/169.html">
            
                    
                    169. 商品详情页动态渲染系统：消息队列架构升级之去重队列
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.47" data-path="dr/170.html">
            
                <a href="dr/170.html">
            
                    
                    170. 商品详情页动态渲染系统：消息队列架构升级之刷数据与高优先级队列
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.48" data-path="dr/171.html">
            
                <a href="dr/171.html">
            
                    
                    171. 商品详情页动态渲染系统：吞吐量优化之批量调用依赖服务接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.49" data-path="dr/172.html">
            
                <a href="dr/172.html">
            
                    
                    172. 商品详情页动态渲染系统：吞吐量优化之 redis mget 批量查询数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.50" data-path="dr/173.html">
            
                <a href="dr/173.html">
            
                    
                    173. 商品详情页动态渲染系统：在分发层 nginx 部署流量分发的 lua 脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.51" data-path="dr/174.html">
            
                <a href="dr/174.html">
            
                    
                    174. 商品详情页动态渲染系统：完成应用层 nginx 的 lua 脚本的编写与部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.52" data-path="dr/175.html">
            
                <a href="dr/175.html">
            
                    
                    175. 商品详情页动态渲染系统：基于 Spring Cloud 开发数据直连服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.53" data-path="dr/176.html">
            
                <a href="dr/176.html">
            
                    
                    176. 商品详情页动态渲染系统：完成多级缓存全链路的测试多个 bug 修复
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.54" data-path="dr/177.html">
            
                <a href="dr/177.html">
            
                    
                    177. 商品详情页动态渲染系统：商品介绍分段存储以及分段加载的介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.55" data-path="dr/178.html">
            
                <a href="dr/178.html">
            
                    
                    178. 商品详情页动态渲染系统：高可用架构优化之读链路多级降级思路介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.56" data-path="dr/179.html">
            
                <a href="dr/179.html">
            
                    
                    179. 商品详情页动态渲染系统：高可用架构优化之 hystrix 隔离与降级
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.57" data-path="dr/180.html">
            
                <a href="dr/180.html">
            
                    
                    180. 商品详情页动态渲染系统：部署 jenkins 持续集成服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.58" data-path="dr/181.html">
            
                <a href="dr/181.html">
            
                    
                    181. 商品详情页动态渲染系统：在 CentOS 6 安装和部署 Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.59" data-path="dr/182.html">
            
                <a href="dr/182.html">
            
                    
                    182. 商品详情页动态渲染系统：在 CentOS 6 安装 maven、git 以及推送 github
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.60" data-path="dr/183.html">
            
                <a href="dr/183.html">
            
                    
                    183. 商品详情页动态渲染系统：通过 jenkins+docker 部署 eureka 服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.61" data-path="dr/184.html">
            
                <a href="dr/184.html">
            
                    
                    184. 商品详情页动态渲染系统：twemproxy hash tag+mget 优化思路介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.62" data-path="onservice/185.md">
            
                <span>
            
                    
                    185. 商品详情页动态渲染系统：所有服务最终修改以及 jenkins+docker 部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.63" data-path="onservice/186.html">
            
                <a href="onservice/186.html">
            
                    
                    186. 商品详情页 OneService 系统：整体架构设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.64" data-path="onservice/187.html">
            
                <a href="onservice/187.html">
            
                    
                    187. 商品详情页 OneService 系统：基于 Spring Cloud 构建 OneService 服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.65" data-path="onservice/188.html">
            
                <a href="onservice/188.html">
            
                    
                    188. 商品详情页 OneService 系统：库存服务与价格服务的代理接口开发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.66" data-path="onservice/189.html">
            
                <a href="onservice/189.html">
            
                    
                    189. 商品详情页 OneService 系统：请求预处理功能设计介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.67" data-path="onservice/190.html">
            
                <a href="onservice/190.html">
            
                    
                    190. 商品详情页 OneService 系统：多服务接口合并设计介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.68" data-path="onservice/191.html">
            
                <a href="onservice/191.html">
            
                    
                    191. 商品详情页 OneService 系统：基于 hystrix 进行接口统一降级
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.69" data-path="onservice/192.html">
            
                <a href="onservice/192.html">
            
                    
                    192. 商品详情页 OneService 系统：基于 hystrix dashboard 进行统一监控
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.70" data-path="onservice/193.html">
            
                <a href="onservice/193.html">
            
                    
                    193. 商品详情页 OneService 系统：基于 jenkins+docker 部署 OneService 服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.71" data-path="onservice/194.html">
            
                <a href="onservice/194.html">
            
                    
                    194. 商品详情页 OneService 系统：基于 jenkins+docker 部署 hystrix terbine 服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.72" data-path="195.html">
            
                <a href="195.html">
            
                    
                    195. 商品详情页前端介绍&课程总结& Java 架构师展望
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >054. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（一）</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;"><b>1. </b>054. &#x57FA;&#x4E8E; nginx + lua + java &#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5206;&#x53D1;&#x5C42;-lua"><b>1.1. </b>&#x5206;&#x53D1;&#x5C42; lua</a></li><li><span class="title-icon "></span><a href="#&#x5E94;&#x7528;&#x5C42;-nginx"><b>1.2. </b>&#x5E94;&#x7528;&#x5C42; nginx</a></li><li><span class="title-icon "></span><a href="#&#x9519;&#x8BEF;&#x89E3;&#x51B3;"><b>1.3. </b>&#x9519;&#x8BEF;&#x89E3;&#x51B3;</a></li><li><span class="title-icon "></span><a href="#&#x6D4B;&#x8BD5;"><b>1.4. </b>&#x6D4B;&#x8BD5;</a></li></ul></ul></div><a href="#054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><ul>
<li><div><a href="#054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;">054. &#x57FA;&#x4E8E; nginx + lua + java &#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;)var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;this.setAttribute(&apos;state&apos;, nextState)this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;} else {    list.style.display = &apos;block&apos;}"></i></div>
<ul>
<li><div><a href="#&#x5206;&#x53D1;&#x5C42;-lua">&#x5206;&#x53D1;&#x5C42; lua</a><i></i></div></li>
<li><div><a href="#&#x5E94;&#x7528;&#x5C42;-nginx">&#x5E94;&#x7528;&#x5C42; nginx</a><i></i></div></li>
<li><div><a href="#&#x9519;&#x8BEF;&#x89E3;&#x51B3;">&#x9519;&#x8BEF;&#x89E3;&#x51B3;</a><i></i></div></li>
<li><div><a href="#&#x6D4B;&#x8BD5;">&#x6D4B;&#x8BD5;</a><i></i></div></li>
</ul></li>
</ul>


<h1 id="054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;"><a name="054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;" class="anchor-navigation-ex-anchor" href="#054-&#x57FA;&#x4E8E;-nginx--lua--java-&#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>1. 054. &#x57FA;&#x4E8E; nginx + lua + java &#x5B8C;&#x6210;&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF08;&#x4E00;&#xFF09;</h1>
<p>&#x672C;&#x8282;&#x8BB2;&#x89E3;&#x5982;&#x4F55;&#x81EA; nginx &#x4E2D;&#x5199; lua &#x811A;&#x672C;&#x628A;&#x7F13;&#x5B58;&#x653E;&#x5230; nginx &#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;</p>
<p>&#x811A;&#x672C;&#x601D;&#x8DEF;&#xFF1A;</p>
<ol>
<li>&#x5E94;&#x7528; nginx &#x7684; lua &#x811A;&#x672C;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;</li>
<li>&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x53C2;&#x6570;&#x4E2D;&#x7684;&#x5546;&#x54C1; id&#xFF0C;&#x4EE5;&#x53CA;&#x5546;&#x54C1;&#x5E97;&#x94FA; id</li>
<li>&#x6839;&#x636E;&#x5546;&#x54C1; id &#x548C;&#x5546;&#x54C1;&#x5E97;&#x94FA; id&#xFF0C;&#x5728; nginx &#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x5C1D;&#x8BD5;&#x83B7;&#x53D6;&#x6570;&#x636E;</li>
<li><p>&#x5982;&#x679C;&#x5728; nginx &#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6570;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x5230; redis &#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4E2D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x5230;&#x4E86;&#x6570;&#x636E;&#xFF0C;&#x8FD8;&#x8981;&#x8BBE;&#x7F6E;&#x5230; nginx &#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;</p>
<p> &#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5EFA;&#x8BAE;&#x4E0D;&#x8981;&#x7528; nginx+lua &#x76F4;&#x63A5;&#x53BB;&#x83B7;&#x53D6; redis &#x6570;&#x636E;</p>
<p> &#x56E0;&#x4E3A; openresty &#x6CA1;&#x6709;&#x592A;&#x597D;&#x7684; redis cluster &#x7684;&#x652F;&#x6301;&#x5305;&#xFF0C;&#x6240;&#x4EE5;&#x5EFA;&#x8BAE;&#x662F;&#x53D1;&#x9001; http &#x8BF7;&#x6C42;&#x5230;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x751F;&#x4EA7;&#x670D;&#x52A1;&#xFF0C;&#x7531;&#x8BE5;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A; http &#x63A5;&#x53E3;</p>
<p> &#x7F13;&#x5B58;&#x6570;&#x751F;&#x4EA7;&#x670D;&#x52A1;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E; redis cluster api &#x4ECE; redis &#x4E2D;&#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x7ED9; nginx</p>
</li>
<li>&#x5982;&#x679C;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x751F;&#x4EA7;&#x670D;&#x52A1;&#x6CA1;&#x6709;&#x5728; redis &#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4E2D;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6570;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x5728;&#x81EA;&#x5DF1;&#x672C;&#x5730; ehcache &#x4E2D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x8FD4;&#x56DE;&#x6570;&#x636E;&#x7ED9; nginx&#xFF0C;&#x4E5F;&#x8981;&#x8BBE;&#x7F6E;&#x5230; nginx &#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;</li>
<li><p>&#x5982;&#x679C; ehcache &#x672C;&#x5730;&#x7F13;&#x5B58;&#x90FD;&#x6CA1;&#x6709;&#x6570;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x53BB;&#x539F;&#x59CB;&#x7684;&#x670D;&#x52A1;&#x4E2D;&#x62C9;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x8BE5;&#x670D;&#x52A1;&#x4F1A;&#x4ECE; mysql &#x4E2D;&#x67E5;&#x8BE2;&#xFF0C;&#x62C9;&#x53D6;&#x5230;&#x6570;&#x636E;&#x4E4B;&#x540E;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9; nginx&#xFF0C;&#x5E76;&#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x5230; ehcache&#x548C; redis &#x4E2D;</p>
<p> &#x8FD9;&#x91CC;&#x5148;&#x4E0D;&#x8003;&#x8651;&#x5E76;&#x53D1;&#x95EE;&#x9898;&#xFF0C;&#x540E;&#x9762;&#x8981;&#x4E13;&#x95E8;&#x8BB2;&#x89E3;&#x4E00;&#x5957;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x91CD;&#x5EFA;&#x5E76;&#x53D1;&#x51B2;&#x7A81;&#x7684;&#x95EE;&#x9898;&#x548C;&#x89E3;&#x51B3;&#x65B9;&#x6848;</p>
</li>
<li>nginx &#x6700;&#x7EC8;&#x5229;&#x7528;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x52A8;&#x6001;&#x6E32;&#x67D3;&#x7F51;&#x9875;&#x6A21;&#x677F;</li>
<li>&#x5C06;&#x6E32;&#x67D3;&#x540E;&#x7684;&#x7F51;&#x9875;&#x6A21;&#x677F;&#x4F5C;&#x4E3A; http &#x54CD;&#x5E94;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x5206;&#x53D1;&#x5C42; nginx</li>
</ol>
<p>&#x4E0B;&#x9762;&#x6765;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x505A;&#xFF1B;</p>
<h2 id="&#x5206;&#x53D1;&#x5C42;-lua"><a name="&#x5206;&#x53D1;&#x5C42;-lua" class="anchor-navigation-ex-anchor" href="#&#x5206;&#x53D1;&#x5C42;-lua"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. &#x5206;&#x53D1;&#x5C42; lua</h2>
<p>eshop-cache03 &#x670D;&#x52A1;&#x5668;&#x4E0A;</p>
<p>/usr/hello/hello.conf</p>
<pre><code>server {
    listen       80;
    server_name  _;
    location /lua {
      default_type &apos;text/html&apos;;
      # &#x9632;&#x6B62;&#x54CD;&#x5E94;&#x4E2D;&#x6587;&#x4E71;&#x7801;
      charset utf-8;
      content_by_lua_file /usr/hello/lua/hello.lua;
    }

    # &#x5206;&#x53D1;&#x903B;&#x8F91;&#x811A;&#x672C;&#x6620;&#x5C04;
    location /product {
      default_type &apos;text/html&apos;;
      # &#x9632;&#x6B62;&#x54CD;&#x5E94;&#x4E2D;&#x6587;&#x4E71;&#x7801;
      charset utf-8;
      content_by_lua_file /usr/hello/lua/distribute.lua;
    }
}
</code></pre><p>/usr/hello/lua/distribute.lua&#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E4B;&#x524D;&#x5199;&#x597D;&#x7684;&#x5206;&#x53D1;&#x903B;&#x8F91;&#x4FEE;&#x6539;&#xFF0C;
&#x56E0;&#x4E3A;&#x60F3;&#x5728;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x4E2D;&#x5199;&#x5B8C;&#x5546;&#x54C1;&#x548C;&#x5E97;&#x94FA;&#x4FE1;&#x606F;&#x7684;&#x5206;&#x53D1;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x8FD8;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; shopId</p>
<pre><code>local uri_args = ngx.req.get_uri_args()
-- &#x83B7;&#x53D6;&#x53C2;&#x6570;
local productId = uri_args[&quot;productId&quot;]
local shopId = uri_args[&quot;shopId&quot;]

-- &#x5B9A;&#x4E49;&#x540E;&#x7AEF;&#x5E94;&#x7528; ip
local host = {&quot;192.168.99.170&quot;, &quot;192.168.99.171&quot;}
-- &#x5BF9;&#x5546;&#x54C1; id &#x53D6;&#x6A21;&#x5E76;&#x8BA1;&#x7B97; hash &#x503C;
local hash = ngx.crc32_long(productId)
hash = (hash % 2) + 1
-- &#x62FC;&#x63A5; http &#x524D;&#x7F00;
backend = &quot;http://&quot;..host[hash]

-- &#x83B7;&#x53D6;&#x5230;&#x53C2;&#x6570;&#x4E2D;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x6BD4;&#x5982;&#x4F60;&#x8981;&#x8BBF;&#x95EE; /hello&#xFF0C;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x662F;&#x9700;&#x8981;&#x4F20;&#x9012;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;
local method = uri_args[&quot;method&quot;]
-- &#x62FC;&#x63A5;&#x5177;&#x4F53;&#x7684;&#x8BBF;&#x95EE;&#x5730;&#x5740;&#x4E0D;&#x5E26; host&#xFF0C;&#x5982;&#xFF1A;/hello?productId=1
local requestBody = &quot;/&quot;..method..&quot;?productId=&quot;..productId..&quot;&amp;shopId=&quot;..shopId

-- &#x83B7;&#x53D6; http &#x5305;
local http = require(&quot;resty.http&quot;)
local httpc = http.new()

-- &#x8BBF;&#x95EE;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x7591;&#x95EE;&#xFF1A;&#x4E07;&#x4E00;&#x6709; cooke &#x8FD9;&#x4E9B;&#x811A;&#x672C;&#x652F;&#x6301;&#x5417;&#xFF1F;&#x4F1A;&#x5F88;&#x9EBB;&#x70E6;&#x5417;&#xFF1F;
local resp, err = httpc:request_uri(backend, {
    method = &quot;GET&quot;,
    path = requestBody,
    keepalive=false
})

-- &#x5982;&#x679C;&#x6CA1;&#x6709;&#x54CD;&#x5E94;&#x5219;&#x8F93;&#x51FA;&#x4E00;&#x4E2A; err &#x4FE1;&#x606F;
if not resp then
    ngx.say(&quot;request error :&quot;, err)
    return
end

-- &#x6709;&#x54CD;&#x5E94;&#x6D4B;&#x8F93;&#x51FA;&#x54CD;&#x5E94;&#x4FE1;&#x606F;
ngx.say(resp.body)  

-- &#x5173;&#x95ED; http &#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x4F8B;
httpc:close()
</code></pre><h2 id="&#x5E94;&#x7528;&#x5C42;-nginx"><a name="&#x5E94;&#x7528;&#x5C42;-nginx" class="anchor-navigation-ex-anchor" href="#&#x5E94;&#x7528;&#x5C42;-nginx"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. &#x5E94;&#x7528;&#x5C42; nginx</h2>
<p>&#x5E94;&#x7528;&#x5C42;&#x5728; eshop-cache01 &#x548C; eshop-cache02 &#x4E0A;&#x3002;
&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x518D; 01 &#x4E0A;&#x5199;&#x5B8C;&#x903B;&#x8F91;&#xFF0C;&#x7136;&#x540E;&#x518D; copy &#x5230; 02 &#x4E0A;&#x3002;</p>
<p>&#x5148;&#x5B89;&#x88C5;&#x4F9D;&#x8D56;&#xFF1A;</p>
<pre><code># &#x9700;&#x8981;&#x518D;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x83B7;&#x53D6;&#x4FE1;&#x606F;&#xFF0C;&#x5B89;&#x88C5; http &#x4F9D;&#x8D56;
cd /usr/hello/lualib/resty/
wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua  
wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua

# &#x62FF;&#x5230;&#x6570;&#x636E;&#x4E4B;&#x540E;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x6A21;&#x677F;&#x6E32;&#x67D3;&#xFF0C;&#x6DFB;&#x52A0; template &#x4F9D;&#x8D56;
# &#x8FD9;&#x91CC;&#x6E32;&#x67D3;&#x4E5F;&#x662F;&#x4F7F;&#x7528; lua &#x6765;&#x5B8C;&#x6210;
cd /usr/hello/lualib/resty/
wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template.lua
mkdir /usr/hello/lualib/resty/html
cd /usr/hello/lualib/resty/html
wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template/html.lua
</code></pre><p>/usr/hello/hello.conf</p>
<pre><code># &#x914D;&#x7F6E; lua &#x7684;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x5B9E;&#x4F8B;&#xFF0C;my_cache &#x662F;&#x6211;&#x4EEC;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x5757;&#x7F13;&#x5B58;&#x540D;&#x79F0;
# &#x8981;&#x914D;&#x7F6E;&#x5728; http &#x4E2D;&#xFF0C;server &#x5916;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x62A5;&#x9519;
# nginx: [emerg] &quot;lua_shared_dict&quot; directive is not allowed here in /usr/hello/hello.conf:11
lua_shared_dict my_cache 128m;
server {  
    listen       80;  
    server_name  _;

    # &#x914D;&#x7F6E;&#x6A21;&#x677F;&#x8DEF;&#x5F84;
    set $template_location &quot;/templates&quot;;  
    # &#x5F53;&#x7136;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x9700;&#x8981;&#x5B58;&#x5728;&#xFF0C;&#x56E0;&#x4E3A;&#x540E;&#x7EED;&#x9700;&#x8981;&#x7528;&#x6765;&#x5B58;&#x653E; html
    set $template_root &quot;/usr/hello/templates&quot;;

    location /lua {  
      default_type &apos;text/html&apos;;  
      # &#x9632;&#x6B62;&#x54CD;&#x5E94;&#x4E2D;&#x6587;&#x4E71;&#x7801;
      charset utf-8;
      content_by_lua_file /usr/hello/lua/hello.lua;
    }

    # &#x914D;&#x7F6E;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#x6620;&#x5C04;&#xFF0C;&#x8BBF;&#x95EE; product &#x7684;&#x65F6;&#x5019;
    # &#x5C31;&#x6267;&#x884C; product.lua &#x811A;&#x672C;&#x6765;&#x5B8C;&#x6210; &#x83B7;&#x53D6;&#x7F13;&#x5B58;&#x6E32;&#x67D3; html &#x5E76;&#x8FD4;&#x56DE; html &#x7684;&#x529F;&#x80FD;
    location /product {
      default_type &apos;text/html&apos;;
      # &#x9632;&#x6B62;&#x54CD;&#x5E94;&#x4E2D;&#x6587;&#x4E71;&#x7801;
      charset utf-8;
      content_by_lua_file /usr/hello/lua/product.lua;
    }    

}
</code></pre><p>/usr/hello/lua/product.lua</p>
<pre><code>local uri_args = ngx.req.get_uri_args()
local productId = uri_args[&quot;productId&quot;]
local shopId = uri_args[&quot;shopId&quot;]

-- &#x83B7;&#x53D6;&#x5230;&#x4E4B;&#x524D;&#x914D;&#x7F6E;&#x4E2D;&#x5206;&#x914D;&#x7684;&#x7F13;&#x5B58;&#x5BF9;&#x8C61;
local cache_ngx = ngx.shared.my_cache

-- &#x62FC;&#x63A5;&#x4E24;&#x4E2A;&#x7F13;&#x5B58; key
local productCacheKey = &quot;product_info_&quot;..productId
local shopCacheKey = &quot;shop_info_&quot;..shopId

-- &#x901A;&#x8FC7;&#x7F13;&#x5B58;&#x5BF9;&#x8C61;&#x83B7;&#x53D6;&#x7F13;&#x5B58;&#x4E2D;&#x7684; value
local productCache = cache_ngx:get(productCacheKey)
local shopCache = cache_ngx:get(shopCacheKey)

-- &#x5982;&#x679C;&#x7F13;&#x5B58;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x5BF9;&#x4E8E;&#x7684; value
-- &#x5C31;&#x8D70;&#x540E;&#x7AEF;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF08;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5148;&#x8D70; redis &#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#x518D;&#x8D70; ehcache&#xFF0C;&#x518D;&#x8D70;&#x6570;&#x636E;&#x5E93;&#xFF09;
if productCache == &quot;&quot; or productCache == nil then
    local http = require(&quot;resty.http&quot;)
    local httpc = http.new()
  -- &#x8FD9;&#x91CC;&#x5730;&#x5740;&#x662F;&#x5F00;&#x53D1;&#x673A;&#x5668; ip&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5728; windows &#x4E0A;&#x5F00;&#x53D1;&#x7684;&#xFF0C;
  -- &#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x5F00;&#x53D1;&#x73AF;&#x5883;&#x6BD4;&#x8F83;&#x65B9;&#x4FBF;
    local resp, err = httpc:request_uri(&quot;http://192.168.99.111:6002&quot;,{
          method = &quot;GET&quot;,
          path = &quot;/getProductInfo?productId=&quot;..productId,
      keepalive=false
    })

    productCache = resp.body
  -- &#x83B7;&#x53D6;&#x5230;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x8BBE;&#x7F6E;&#x5230;&#x7F13;&#x5B58;&#x4E2D;
    cache_ngx:set(productCacheKey, productCache, 10 * 60)
end

if shopCache == &quot;&quot; or shopCache == nil then
    local http = require(&quot;resty.http&quot;)
    local httpc = http.new()

    local resp, err = httpc:request_uri(&quot;http://192.168.99.111:6002&quot;,{
          method = &quot;GET&quot;,
          path = &quot;/getShopInfo?shopId=&quot;..shopId,
      keepalive=false
    })

    shopCache = resp.body
    cache_ngx:set(shopCacheKey, shopCache, 10 * 60)
end

-- &#x56E0;&#x4E3A;&#x5B58;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#x662F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;
-- &#x6240;&#x4EE5;&#x4F7F;&#x7528; cjson &#x5E93;&#x628A;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6210; json &#x5BF9;&#x8C61;
local cjson = require(&quot;cjson&quot;)
local productCacheJSON = cjson.decode(productCache)
local shopCacheJSON = cjson.decode(shopCache)

-- &#x628A;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x548C;&#x5E97;&#x94FA;&#x4FE1;&#x606F;&#x62FC;&#x63A5;&#x5230;&#x4E00;&#x4E2A;&#x5927; json &#x5BF9;&#x8C61;&#x4E2D;
-- &#x8FD9;&#x6837;&#x505A;&#x7684;&#x539F;&#x56E0;&#x662F;&#xFF1A;template &#x6E32;&#x67D3;&#x9700;&#x8981;&#x8FD9;&#x6837;&#x505A;
local context = {
    productId = productCacheJSON.id,
    productName = productCacheJSON.name,
    productPrice = productCacheJSON.price,
    productPictureList = productCacheJSON.pictureList,
    productSpecification = productCacheJSON.specification,
    productService = productCacheJSON.service,
    productColor = productCacheJSON.color,
    productSize = productCacheJSON.size,
    shopId = shopCacheJSON.id,
    shopName = shopCacheJSON.name,
    shopLevel = shopCacheJSON.level,
    shopGoodCommentRate = shopCacheJSON.goodCommentRate
}

-- &#x4F7F;&#x7528; template &#x6E32;&#x67D3; product.html &#x6A21;&#x677F;
local template = require(&quot;resty.template&quot;)
template.render(&quot;product.html&quot;, context)
</code></pre><p>product.html &#x5185;&#x5BB9;&#xFF0C;&#x5C31;&#x662F;&#x5F88;&#x7B80;&#x5355;&#x7684;&#x63D2;&#x503C;&#x5360;&#x4F4D;</p>
<pre><code class="lang-html">product id: {* productId *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product name: {* productName *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product picture list: {* productPictureList *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product specification: {* productSpecification *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product service: {* productService *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product color: {* productColor *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
product size: {* productSize *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
shop id: {* shopId *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
shop name: {* shopName *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
shop level: {* shopLevel *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
shop good cooment rate: {* shopGoodCommentRate *}<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
</code></pre>
<p>&#x914D;&#x7F6E;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8BB0;&#x5F97;&#x6D4B;&#x8BD5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x548C;&#x91CD;&#x542F; nginx</p>
<pre><code class="lang-bash">/usr/servers/nginx/sbin/nginx -t
/usr/servers/nginx/sbin/nginx <span class="hljs-_">-s</span> reload
</code></pre>
<h2 id="&#x9519;&#x8BEF;&#x89E3;&#x51B3;"><a name="&#x9519;&#x8BEF;&#x89E3;&#x51B3;" class="anchor-navigation-ex-anchor" href="#&#x9519;&#x8BEF;&#x89E3;&#x51B3;"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. &#x9519;&#x8BEF;&#x89E3;&#x51B3;</h2>
<p>&#x5982;&#x679C;&#x62A5;&#x9519; <code>product.lua:20: module &apos;resty.http&apos; not found:</code> &#x90A3;&#x4E48;&#x8BF7;&#x68C0;&#x67E5;</p>
<pre><code class="lang-bash">vi /usr/servers/nginx/conf/nginx.conf
&#x8FD9;&#x91CC;&#x5F15;&#x5165;&#x7684;&#x5185;&#x5BB9;&#x662F;&#x5426;&#x662F; hello &#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x3002;
http {
    lua_package_path <span class="hljs-string">&quot;/usr/hello/lualib/?.lua;;&quot;</span>;
    lua_package_cpath <span class="hljs-string">&quot;/usr/hello/lualib/?.so;;&quot;</span>;
</code></pre>
<h2 id="&#x6D4B;&#x8BD5;"><a name="&#x6D4B;&#x8BD5;" class="anchor-navigation-ex-anchor" href="#&#x6D4B;&#x8BD5;"><i class="fa fa-link" aria-hidden="true"></i></a>1.4. &#x6D4B;&#x8BD5;</h2>
<p>&#x8BBF;&#x95EE;&#x5730;&#x5740;&#xFF1A;<code>http://eshop-cache02/product?productId=1&amp;shopId=1</code></p>
<p>&#x80AF;&#x5B9A;&#x4F1A;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x4E3A;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x90FD;&#x6CA1;&#x6709;&#x5199;&#x7684;&#x3002;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x65E5;&#x5FD7;&#x62A5;&#x9519;&#x4FE1;&#x606F;</p>
<pre><code>tail -f /usr/servers/nginx/logs/error.log
&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x4E0B;&#x7684;&#x9519;&#x8BEF;&#xFF1A;

2019/05/06 22:19:10 [error] 8758#0: *34 connect() failed (113: No route to host), client: 192.168.99.1, server: _, request: &quot;GET /product?productId=1&amp;shopId=1 HTTP/1.1&quot;, host: &quot;eshop-cache02&quot;
2019/05/06 22:19:10 [error] 8758#0: *34 lua entry thread aborted: runtime error: /usr/hello/lua/product.lua:29: attempt to index local &apos;resp&apos; (a nil value)
stack traceback:
coroutine 0:
    /usr/hello/lua/product.lua: in function &lt;/usr/hello/lua/product.lua:1&gt;, client: 192.168.99.1, server: _, request: &quot;GET /product?productId=1&amp;shopId=1 HTTP/1.1&quot;, host: &quot;eshop-cache02&quot;
</code></pre><p>&#x770B;&#x5230;&#x53BB;&#x8BBF;&#x95EE;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x4E86;&#xFF0C;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#x3002;&#x4E0B;&#x4E00;&#x7AE0;&#x7EE7;&#x7EED;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x7684;&#x7F16;&#x5199;</p>
<p>::: tip
&#x7531;&#x4E8E;&#x642C;&#x5BB6;&#xFF0C;&#x5BBF;&#x4E3B;&#x673A; IP &#x53D8;&#x66F4;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x865A;&#x62DF;&#x673A;&#x4E0A;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x4E86;&#x597D;&#x591A;&#x8F6F;&#x4EF6;&#x3002;
&#x6CA1;&#x6709;&#x8010;&#x5FC3;&#x518D;&#x4FEE;&#x6539;&#x4E00;&#x6B21; IP &#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6539;&#x7528;&#x4E86; hostonly &#x6765;&#x4FDD;&#x8BC1;&#x865A;&#x62DF;&#x673A;&#x548C;&#x5BBF;&#x4E3B;&#x673A;&#x7684;&#x8054;&#x901A;&#xFF0C;&#x5E76;&#x4E14;&#x865A;&#x62DF;&#x673A;&#x53EF;&#x4EE5;&#x4E0A;&#x7F51;&#x3002;<a href="_posts/virtualbox">&#x8BBE;&#x7F6E;&#x65B9;&#x6CD5;&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;</a>&#xFF1B;</p>
<p>&#x6240;&#x4EE5;&#x540E;&#x7EED;&#x5BF9;&#x5BBF;&#x4E3B;&#x673A;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x4F1A;&#x66F4;&#x6539; IP &#xFF0C;&#x4E0E;&#x8FD9;&#x4E4B;&#x524D;&#x7684;&#x7B14;&#x8BB0;&#x4E2D;&#x770B;&#x5230;&#x7684; IP &#x4F1A;&#x4E0D;&#x4E00;&#x81F4;
:::</p>
<footer class="footer"><div class="footer__container--normal" alt=""><div class="footer__description--normal"><p class="paragraph footer__author--normal" style="color: #000 !important;">kaisesai<sup class="super">&#xAE;</sup></p><p class="paragraph footer__quote--normal" style="color: #000 !important;">&#x559C;&#x6B22;&#x82B1;&#x65F6;&#x95F4;&#x53BB;&#x9F13;&#x6363;&#x5404;&#x79CD;&#x6280;&#x672F;~</p><div class="footer__main--normal"><p class="paragraph footer__main__paragraph--normal copyright" style="color: #666 !important;">Copyright &#xA9; &#x5218;&#x51EF;&#xFF08;kaisesai&#xFF09; all right reserved</p><p class="paragraph footer__main__paragraph--normal footer__modifyTime--normal" style="color: #666 !important;"><span style="color: #666 !important;">modified at</span>
2020-05-06 15:39:48
</p></div></div></div><div class="box__issues">

</div></footer>
<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="053.html" class="navigation navigation-prev " aria-label="Previous page: 053. 部署分发层 nginx 以及基于 lua 完成基于商品 id 的定向流量分发策略">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="055.html" class="navigation navigation-next " aria-label="Next page: 055. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（二）">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"054. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（一）","level":"1.52","depth":1,"next":{"title":"055. 基于 nginx + lua + java 完成多级缓存架构的核心业务逻辑（二）","level":"1.53","depth":1,"path":"055.md","ref":"./055.md","articles":[]},"previous":{"title":"053. 部署分发层 nginx 以及基于 lua 完成基于商品 id 的定向流量分发策略","level":"1.51","depth":1,"path":"053.md","ref":"./053.md","articles":[]},"dir":"ltr"},"config":{"plugins":["flexible-alerts","pageview-count","-lunr","-search","search-pro","splitter","page-copyright","todo","multipart","code","popup","page-treeview","anchor-navigation-ex","livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"page-treeview":{"copyright":"Copyright © aleen42","minHeaderCount":"2","minHeaderDeep":"2"},"livereload":{},"todo":{},"splitter":{},"search-pro":{},"page-copyright":{"wisdom":"喜欢花时间去鼓捣各种技术~","noPowered":true,"copyright":"Copyright &#169; 刘凯（kaisesai）","styles (normal, symmetrical)":"normal","style":"normal","isShowQRCode":false,"timeColor":"#666","utcOffset":"8","format":"YYYY-MM-dd hh:mm:ss","signature":"kaisesai","baseUri":"https://github.com/skyFi","copyrightColor":"#666","description":"modified at"},"popup":{},"multipart":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"anchor-navigation-ex":{"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":true},"pageview-count":{},"flexible-alerts":{"danger":{"className":"danger","icon":"fa fa-ban","label":"Attention"},"note":{"className":"info","icon":"fa fa-info-circle","label":"Note"},"style":"callout","tip":{"className":"tip","icon":"fa fa-lightbulb-o","label":"Tip"},"warning":{"className":"warning","icon":"fa fa-exclamation-triangle","label":"Warning"}},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"刘凯（kaisesai）","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"亿级流量电商详情页系统实战","language":"zh-hans","gitbook":"*","description":"中华石杉老师的亿级流量电商详情页系统实战"},"file":{"path":"054.md","mtime":"2020-05-06T07:39:48.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-05-24T09:29:10.986Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-flexible-alerts/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

